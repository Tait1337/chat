<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Chat</title>
    </head>
    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: Monospace;
        }

        body {
            min-height: 100vh;
            display: grid;
            grid-template-columns: auto;
            grid-template-rows: 120px auto 20px;
        }

        header {
            justify-self: center;
        }
        main {
            justify-self: center;
            text-align: center;
        }
        footer {
            justify-self: end;
        }

        header h1 {
            font-size: 6em;
        }
        main h2 {
            font-size: 2em;
        }

        #logout-form, #chat-form {
            display: none;
        }

        #chat-form {
            grid-template-columns: 12em auto 5em;
            gap: 0.5em;
        }
        #chat-form textarea {
            height: 40vh;
            width: 75vw;
            overflow: scroll;
            grid-column-end: span 3;
        }
    </style>
    <script>
        class Message {
            constructor(type, timestamp, sender, payload) {
                this.type = type;
                this.timestamp = timestamp;
                this.sender = sender;
                this.payload = payload;
            }
        }

        class ChatMessage {
            static TYPE = 'CHAT';
            constructor(receiver, text) {
                this.receiver = receiver;
                this.text = text;
            }
        }

        class ParticipantMessage {
            static TYPE = 'PARTICIPANT';
            static ACTION_JOIN = 'JOIN';
            static ACTION_LEAVE = 'LEAVE';

            constructor(action, user) {
                this.action = action;
                this.user = user;
            }
        }

        var username;

        var clientWebSocket;

        var protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        var host = window.location.host;
        var pathname = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        var endpoint = 'chat';
        var url = protocol + host + pathname + endpoint;

        function join() {
            var loginform = document.getElementById('login-form');
            var logoutform = document.getElementById('logout-form');
            var chatform = document.getElementById('chat-form');
            var welcomeIcon = document.getElementById('welcome-icon');
            var welcomeText = document.getElementById('welcome-text');
            loginform.style.display='none';
            logoutform.style.display='block';
            chatform.style.display='grid';
            chatform.msg.focus();
            username = loginform.username.value;
            welcomeIcon.innerHTML='(^̮^)';
            welcomeText.innerHTML='Welcome, ' + username;
            clientWebSocket = new WebSocket(url);
            clientWebSocket.onmessage = function(conn) {
                handleMsg(JSON.parse(conn.data));
            }
            clientWebSocket.onopen = function() {
                var payload = new ParticipantMessage(ParticipantMessage.ACTION_JOIN, {username:username});
                var msg = new Message(ParticipantMessage.TYPE, Date.now(), username, JSON.stringify(payload));
                clientWebSocket.send(JSON.stringify(msg));
            }
        }

        function handleMsg(msg) {
            var payload = JSON.parse(msg.payload);
            var chatform = document.getElementById('chat-form');
            if (msg.type === ChatMessage.TYPE) {
                chatform.chat.value += '\n['+ new Date(msg.timestamp).toLocaleString() + '] ' + getParticipantName(msg.sender) + ': ' + payload.text;
            } else if (msg.type === ParticipantMessage.TYPE) {
                var recipientOptions = '';
                for (var key in payload.user) {
                  recipientOptions+='<option value="'+key+'">'+payload.user[key]+'</option>';
                }
                if (payload.action === ParticipantMessage.ACTION_JOIN){
                    document.getElementById('recipient').innerHTML = recipientOptions;
                    chatform.chat.value += '\n['+ new Date(msg.timestamp).toLocaleString() + '] ' + getParticipantName(msg.sender) + ' has joined the chat';
                } else if (payload.action === ParticipantMessage.ACTION_LEAVE){
                    chatform.chat.value += '\n['+ new Date(msg.timestamp).toLocaleString() + '] ' + getParticipantName(msg.sender) + ' has left the chat';
                    document.getElementById('recipient').innerHTML = recipientOptions;
                }
            }
            chatform.chat.scrollTop = chatform.chat.scrollHeight;
        }

        function getParticipantName(participantId){
            var recipient = document.getElementById('recipient');
            for (var i = 0; i < recipient.length; i++){
                var option = recipient.options[i];
                if (option.value === participantId){
                    return option.text;
                }
            }
        }

        function leave() {
            var payload = new ParticipantMessage(ParticipantMessage.ACTION_LEAVE, {username:username});
            var msg = new Message(ParticipantMessage.TYPE, Date.now(), username, JSON.stringify(payload));
            clientWebSocket.send(JSON.stringify(msg));
            clientWebSocket.close();
            location.reload();
        }
        window.onbeforeunload = function(e) { leave(); };

        function sendMsg() {
            var chatform = document.getElementById('chat-form');
            var payload = new ChatMessage(chatform.recipient.value, chatform.msg.value);
            var msg = new Message(ChatMessage.TYPE, Date.now(), username, JSON.stringify(payload));
            clientWebSocket.send(JSON.stringify(msg));
            chatform.msg.value = '';
            chatform.msg.focus();
        }
    </script>
<body>
    <header>
        <h1>Chat</h1>
    </header>
    <main>
        <h2 id="welcome-icon">¯\_(ツ)_/¯</h2>
        <h2 id="welcome-text">What's your name?</h2>
        <form id="login-form" onsubmit="join(); event.preventDefault();">
            <input name="username" type="text" placeholder="Username" minlength="3" required autofocus>
            <button type="button">Join</button>
        </form>

        <form id="logout-form" onsubmit="leave(); event.preventDefault();">
            <button type="submit">Leave</button>
        </form>

        <br><br><br>
        <form id="chat-form" onsubmit="sendMsg(); event.preventDefault();">
            <textarea id="chat" readonly></textarea>
            <select id="recipient"></select>
            <input name="msg" type="text" placeholder="Message" required>
            <button type="submit">Send</button>
        </form>
    </main>
    <footer>
        <p>Copyright © 2021 Oliver Tribess</p>
    </footer>
</body>
</html>